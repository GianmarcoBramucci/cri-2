<!DOCTYPE html>
<html lang="it" class="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Assistente Croce Rossa Italiana</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- AOS Animation Library -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" />
  <!-- Marked.js per il parsing del Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    // Tailwind Config from second file
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            cri: {
              red: '#e3000f',
              darkred: '#b80000',
              lightred: '#ff3b4a',
            },
          },
          fontFamily: {
            sans: ['Montserrat', 'sans-serif'],
            display: ['Playfair Display', 'serif'],
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'typing': 'typing 1.5s infinite',
            'wave': 'wave 8s linear infinite',
            'floating': 'floating 5s ease-in-out infinite',
            'slide-in-right': 'slideInRight 0.4s ease forwards',
            'slide-in-left': 'slideInLeft 0.4s ease forwards',
            'fade-in': 'fadeIn 0.4s ease forwards',
            'scale-in': 'scaleIn 0.3s ease forwards',
            'bounce-in': 'bounceIn 0.5s ease forwards',
          },
          keyframes: {
            typing: {
              '0%, 100%': { transform: 'translateY(0px)' },
              '50%': { transform: 'translateY(-6px)' },
            },
            wave: {
              '0%': { transform: 'translateX(0)' },
              '100%': { transform: 'translateX(-50%)' },
            },
            floating: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-6px)' },
            },
            slideInRight: {
              '0%': { opacity: '0', transform: 'translateX(20px)' },
              '100%': { opacity: '1', transform: 'translateX(0)' }
            },
            slideInLeft: {
              '0%': { opacity: '0', transform: 'translateX(-20px)' },
              '100%': { opacity: '1', transform: 'translateX(0)' }
            },
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            scaleIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
            bounceIn: { '0%': { opacity: '0', transform: 'scale(0.8)' }, '60%': { opacity: '1', transform: 'scale(1.05)' }, '80%': { transform: 'scale(0.98)' }, '100%': { transform: 'scale(1)' } },
          },
           screens: { // Tailwind default breakpoints: sm: 640px, md: 768px, lg: 1024px, xl: 1280px
            'xs': '480px', // Custom extra small
          }
        },
      },
    }
  </script>
  <style>
    html { scroll-behavior: smooth; }
    body { font-family: 'Montserrat', sans-serif; overflow: hidden; background-color: #f9fafb; }
    .dark body { background-color: #111827; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(209, 213, 219, 0.5); border-radius: 10px; }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(75, 85, 99, 0.6); }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: rgba(156, 163, 175, 0.7); }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: rgba(107, 114, 128, 0.8); }
    .parallax-header { background: linear-gradient(135deg, #e3000f 0%, #b80000 100%); position: relative; }
    .parallax-header::before { content: ''; position: absolute; inset: 0; background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 6V5zM6 5v1H5z'/%3E%3C/g%3E%3C/svg%3E"); opacity: 0.5; z-index: 0; }
    .cross-pattern-bg { background-color: #f9fafb; background-image: url("data:image/svg+xml,%3Csvg width='30' height='30' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e3000f' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); }
    .dark .cross-pattern-bg { background-color: #111827; background-image: url("data:image/svg+xml,%3Csvg width='30' height='30' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e3000f' fill-opacity='0.06'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); }
    .card-styled { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .card-styled:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.07); }
    .dark .card-styled:hover { box-shadow: 0 8px 25px rgba(227, 0, 15, 0.1); }
    .typing-dot { animation: typing 1.5s infinite ease-in-out; }
    .typing-dot:nth-child(1) { animation-delay: 0s; } .typing-dot:nth-child(2) { animation-delay: 0.2s; } .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    .modal-container { display: flex; align-items: center; justify-content: center; position: fixed; inset: 0; background-color: rgba(17, 24, 39, 0.6); z-index: 100; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    .modal-container.active { opacity: 1; pointer-events: auto; }
    .modal-content { transform: scale(0.95) translateY(10px); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; max-height: 90vh; width: 90%; }
    .modal-container.active .modal-content { transform: scale(1) translateY(0); opacity: 1; }
    .spinner { width: 24px; height: 24px; border-radius: 50%; border: 3px solid rgba(227, 0, 15, 0.1); border-top-color: #e3000f; animation: spin 1s infinite linear; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .widget-container { position: relative; min-height: 350px; display: flex; align-items: center; justify-content: center; width: 100%; background-color: rgba(0,0,0,0.02); border-radius: 0.5rem; }
    .dark .widget-container { background-color: rgba(255,255,255,0.03); }
    elevenlabs-convai { position: static !important; top: auto !important; left: auto !important; transform: none !important; margin: 0 auto !important; width: 100%; max-width: 400px; height: auto; min-height: 350px; }
    @supports(padding: max(0px)) { .safe-bottom { padding-bottom: max(1rem, env(safe-area-inset-bottom)); } .safe-left { padding-left: max(1rem, env(safe-area-inset-left)); } .safe-right { padding-right: max(1rem, env(safe-area-inset-right)); } }
    @supports (padding-top: constant(safe-area-inset-top)) { .safe-top { padding-top: constant(safe-area-inset-top); } }
    @supports (padding-top: env(safe-area-inset-top)) { .safe-top { padding-top: env(safe-area-inset-top); } }
    html, body { overscroll-behavior-y: contain; height: 100%; width: 100%; }
    *:focus:not(:focus-visible) { outline: none; box-shadow: none; }
    *:focus-visible { outline: 2px solid #ff3b4a; outline-offset: 2px; box-shadow: 0 0 0 4px rgba(227, 0, 15, 0.2); border-radius: 2px; }
    textarea:focus-visible { outline-color: #e3000f; box-shadow: 0 0 0 3px rgba(227, 0, 15, 0.15); border-radius: 0.75rem; }
    .message-bubble { clear: both; }
    .prose-chat p { margin-top: 0.5em; margin-bottom: 0.5em; } .prose-chat ul, .prose-chat ol { margin-top: 0.5em; margin-bottom: 0.5em; padding-left: 1.2em; } .prose-chat li { margin-top: 0.2em; margin-bottom: 0.2em; } .prose-chat h1, .prose-chat h2, .prose-chat h3, .prose-chat h4 { margin-bottom: 0.5em; margin-top: 1em; }

    /* Responsive Fix: Ensure mobile menu button is always available when sidebar is hidden */
    #mobile-menu-btn { display: none; } /* Hide by default */
    @media (max-width: 767.98px) { /* Below md breakpoint */
        #mobile-menu-btn { display: flex; } /* Show mobile menu button */
        #sidebar { display: none; } /* Ensure sidebar is hidden */
    }
    @media (min-width: 768px) { /* md breakpoint and above */
        #mobile-menu-btn { display: none; } /* Hide mobile menu button */
        #sidebar { display: flex; } /* Show desktop sidebar */
    }


  </style>
</head>
<body class="cross-pattern-bg h-dvh flex flex-col dark:bg-gray-900 dark:text-gray-100 font-sans">
  <!-- Fixed top notification banner -->
  <div id="notification-banner" class="fixed top-0 left-0 right-0 bg-cri-red text-white py-2 px-4 z-[110] shadow-lg transform -translate-y-full transition-transform duration-300 ease-in-out safe-top">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-2"><i class="fas fa-bell text-sm"></i><span id="notification-text" class="text-sm font-medium">Notifica!</span></div>
      <button id="close-notification" aria-label="Chiudi notifica" class="text-white opacity-70 hover:opacity-100 transition-opacity"><i class="fas fa-times"></i></button>
    </div>
  </div>

  <!-- App container -->
  <div class="flex flex-col h-full overflow-hidden">
    <!-- HEADER -->
    <header class="parallax-header z-30 relative safe-top flex-shrink-0">
      <div class="flex justify-between items-center px-4 md:px-6 py-3 relative z-10">
        <div class="flex items-center gap-2 md:gap-3">
          <div class="w-9 h-9 md:w-10 md:h-10 rounded-lg bg-white flex items-center justify-center shadow-md animate-pulse-slow"><svg class="w-5 h-5 md:w-6 md:h-6" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" rx="16" fill="white"/><rect x="43" y="20" width="14" height="60" fill="#E3000F"/><rect x="20" y="43" width="60" height="14" fill="#E3000F"/></svg></div>
          <div><h1 class="text-base sm:text-lg md:text-xl font-semibold text-white tracking-tight font-display">Assistente CRI</h1><p class="text-xs text-white text-opacity-70 hidden sm:block">Croce Rossa Italiana</p></div>
        </div>
        <div class="flex items-center space-x-2">
          <!-- Desktop Tab selector: REMOVED Analysis Tab -->
          <div class="hidden sm:flex bg-white bg-opacity-10 rounded-full p-1 shadow-inner">
            <button id="tab-chat-btn" aria-label="Vai alla chat" class="tab-switcher px-3 py-1 text-xs font-medium text-white rounded-full transition-all hover:bg-white/20"><i class="fas fa-comments mr-1 opacity-80"></i> Chat</button>
            <button id="tab-voice-btn" aria-label="Vai all'assistente vocale" class="tab-switcher px-3 py-1 text-xs font-medium text-white rounded-full transition-all hover:bg-white/20"><i class="fas fa-microphone mr-1 opacity-80"></i> Vocale</button>
          </div>
          <button id="theme-toggle" aria-label="Cambia tema" class="w-9 h-9 md:w-10 md:h-10 rounded-full bg-white bg-opacity-10 flex items-center justify-center text-white hover:bg-white/20 transition-all"><i class="fas fa-moon text-lg"></i></button>
          <!-- Mobile menu button: ID and visibility controlled by CSS based on breakpoints -->
          <button id="mobile-menu-btn" aria-label="Apri menu" class="w-9 h-9 md:w-10 md:h-10 rounded-full bg-white bg-opacity-10 flex items-center justify-center text-white hover:bg-white/20 transition-all">
            <i class="fas fa-bars text-lg"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- Main content wrapper -->
    <div class="flex flex-1 overflow-hidden">
      <!-- Desktop Sidebar: ID "sidebar" -->
      <aside id="sidebar" class="flex-col w-64 lg:w-72 bg-white dark:bg-gray-800/50 dark:border-gray-700 shadow-sm z-20 border-r border-gray-100 transition-all duration-300 flex-shrink-0">
        <div class="p-3 border-b border-gray-100 dark:border-gray-700"><div class="flex items-center justify-between"><h2 class="font-semibold text-sm text-gray-600 dark:text-gray-300">Conversazioni</h2><button id="new-chat-btn" aria-label="Nuova conversazione" title="Nuova conversazione" class="w-8 h-8 rounded-lg bg-red-50 dark:bg-red-900/30 flex items-center justify-center text-cri-red hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors focus-visible:ring-2 focus-visible:ring-cri-red focus-visible:ring-offset-1"><i class="fas fa-plus"></i></button></div></div>
        <div id="chats-list" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar"><!-- Chat items --></div>
        <div class="p-3 border-t border-gray-100 dark:border-gray-700"><div class="space-y-1"><button id="guide-btn" class="w-full flex items-center px-3 py-1.5 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors text-sm"><i class="fas fa-question-circle w-4 text-center mr-2 text-cri-red/80"></i>Guida</button><a href="https://cri.it" target="_blank" rel="noopener noreferrer" class="w-full flex items-center px-3 py-1.5 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors text-sm"><i class="fas fa-external-link-alt w-4 text-center mr-2 text-cri-red/80"></i>Sito CRI</a><button id="privacy-btn" class="w-full flex items-center px-3 py-1.5 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors text-sm"><i class="fas fa-shield-alt w-4 text-center mr-2 text-cri-red/80"></i>Privacy</button></div><div class="mt-3 pt-3 border-t border-gray-100 dark:border-gray-700/50 text-xs text-center text-gray-400 dark:text-gray-500">Versione 2.1</div></div> <!-- Updated version -->
      </aside>

      <!-- Mobile Sidebar (Off-canvas) -->
      <div id="mobile-sidebar" class="fixed inset-0 z-[60] hidden"> <!-- Keep md:hidden from original for JS toggle -->
        <div id="mobile-backdrop" class="absolute inset-0 bg-black/40 backdrop-blur-sm opacity-0 transition-opacity duration-300 ease-in-out"></div>
        <div class="mobile-sidebar-content absolute top-0 left-0 bottom-0 w-[85%] max-w-xs bg-white dark:bg-gray-800 shadow-xl transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col safe-left">
          <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between flex-shrink-0"><div class="flex items-center gap-2"><div class="w-8 h-8 rounded-lg bg-cri-red flex items-center justify-center shadow-md"><i class="fas fa-bars text-white text-sm"></i></div><h2 class="font-semibold text-gray-700 dark:text-gray-200">Menu</h2></div><button id="close-mobile-menu" aria-label="Chiudi menu" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-times text-xl"></i></button></div>
          <!-- Mobile Tabs: REMOVED Analysis Tab -->
          <div class="p-3 border-b border-gray-100 dark:border-gray-700 flex-shrink-0">
            <div class="grid grid-cols-2 gap-2"> <!-- Changed to grid-cols-2 -->
              <button data-tab="chat" class="mobile-tab-btn flex flex-col items-center py-2 rounded-lg text-sm font-medium transition-colors"><i class="fas fa-comments mb-1 text-lg"></i><span class="text-xs">Chat</span></button>
              <button data-tab="voice" class="mobile-tab-btn flex flex-col items-center py-2 rounded-lg text-sm font-medium transition-colors"><i class="fas fa-microphone mb-1 text-lg"></i><span class="text-xs">Vocale</span></button>
            </div>
          </div>
          <div id="mobile-chats-list" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar"><!-- Chat items with delete buttons --></div>
          <div class="p-3 border-t border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 flex-shrink-0 safe-bottom">
            <div class="space-y-1 mb-3"><button id="mobile-guide-btn" class="w-full flex items-center px-3 py-1.5 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors text-sm"><i class="fas fa-question-circle w-4 text-center mr-2 text-cri-red/80"></i>Guida</button><a href="https://cri.it" target="_blank" rel="noopener noreferrer" class="w-full flex items-center px-3 py-1.5 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors text-sm"><i class="fas fa-external-link-alt w-4 text-center mr-2 text-cri-red/80"></i>Sito CRI</a><button id="mobile-privacy-btn" class="w-full flex items-center px-3 py-1.5 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors text-sm"><i class="fas fa-shield-alt w-4 text-center mr-2 text-cri-red/80"></i>Privacy</button></div>
            <button id="mobile-new-chat-btn" aria-label="Nuova conversazione" class="w-full flex items-center justify-center px-3 py-2.5 rounded-lg bg-cri-red text-white hover:bg-cri-darkred transition-colors text-sm font-medium shadow-sm"><i class="fas fa-plus mr-2"></i>Nuova chat</button>
          </div>
        </div>
      </div>

      <!-- Main content area -->
      <main class="flex-1 flex flex-col overflow-hidden bg-gray-50 dark:bg-gray-900/80">
        <div id="tab-container" class="flex-1 flex flex-col overflow-hidden">
          <!-- === CHAT TAB === -->
          <div id="tab-chat" class="flex-1 flex flex-col overflow-hidden">
            <div class="px-3 sm:px-4 py-2 border-b border-gray-100 dark:border-gray-700/50 bg-white dark:bg-gray-800/60 shadow-sm z-10 flex-shrink-0"><div class="overflow-x-auto custom-scrollbar pb-1 -mx-1 px-1"><div class="flex gap-2 whitespace-nowrap"><button class="suggestion-chip px-3 py-1 bg-red-50 dark:bg-red-900/30 text-cri-red text-xs sm:text-sm rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors">Come diventare volontario?</button><button class="suggestion-chip px-3 py-1 bg-red-50 dark:bg-red-900/30 text-cri-red text-xs sm:text-sm rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors">Corsi primo soccorso</button><button class="suggestion-chip px-3 py-1 bg-red-50 dark:bg-red-900/30 text-cri-red text-xs sm:text-sm rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors">Donare sangue</button><button class="suggestion-chip px-3 py-1 bg-red-50 dark:bg-red-900/30 text-cri-red text-xs sm:text-sm rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors">Emergenze attive</button><button class="suggestion-chip px-3 py-1 bg-red-50 dark:bg-red-900/30 text-cri-red text-xs sm:text-sm rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors">Come donare</button></div></div></div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-3 sm:p-4 space-y-4 custom-scrollbar">
              <!-- Welcome message is added dynamically by loadChatMessages if chat is empty -->
            </div>
            <div class="relative z-10 flex-shrink-0"><div class="bg-white dark:bg-gray-800/80 dark:border-gray-700 p-3 sm:p-4 border-t border-gray-100 shadow-inner safe-bottom backdrop-blur-sm"><div class="max-w-4xl mx-auto"><form id="chat-form" class="flex items-end gap-2"><div class="relative flex-grow"><textarea id="message-input" rows="1" placeholder="Scrivi un messaggio..." aria-label="Messaggio da inviare" class="w-full rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 px-4 py-2.5 pr-10 text-sm sm:text-base text-gray-800 dark:text-gray-100 focus:border-cri-red focus:ring-1 focus:ring-cri-red focus:outline-none transition-all resize-none custom-scrollbar" style="max-height: 120px;"></textarea><button type="submit" id="send-message-btn" aria-label="Invia messaggio" disabled class="absolute right-2 bottom-2 text-cri-red p-1.5 rounded-full hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors disabled:opacity-30 disabled:cursor-not-allowed"><i class="fas fa-paper-plane text-lg"></i></button></div></form><div class="mt-1.5 flex justify-between items-center text-xs text-gray-400 dark:text-gray-500 px-1"><div class="hidden sm:flex items-center gap-1"><kbd class="px-1 py-0.5 bg-gray-100 dark:bg-gray-600 rounded border border-gray-200 dark:border-gray-500 text-[10px]">Enter</kbd><span class="text-[10px]">per inviare</span> <span class="mx-1 text-[10px]">•</span> <kbd class="px-1 py-0.5 bg-gray-100 dark:bg-gray-600 rounded border border-gray-200 dark:border-gray-500 text-[10px]">Shift</span>+<kbd class="px-1 py-0.5 bg-gray-100 dark:bg-gray-600 rounded border border-gray-200 dark:border-gray-500 text-[10px]">Enter</kbd><span class="text-[10px]">per a capo</span></div><div class="text-xs text-gray-400 dark:text-gray-500">Powered by <span class="font-medium text-gray-500 dark:text-gray-400">CRI</span></div></div></div></div></div>
          </div>
          <!-- === VOICE ASSISTANT TAB === -->
          <div id="tab-voice" class="hidden flex-1 flex flex-col overflow-y-auto p-4 sm:p-6 custom-scrollbar">
            <div class="max-w-3xl mx-auto w-full flex-1 flex flex-col gap-6">
              <div class="card-styled bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 p-4 sm:p-6 animate-fade-in"><div class="flex items-center justify-between mb-4 pb-4 border-b border-gray-100 dark:border-gray-700/50"><h2 class="text-lg sm:text-xl font-semibold text-gray-800 dark:text-white flex items-center gap-2 font-display"><i class="fas fa-microphone text-cri-red"></i>Assistente Vocale</h2><span class="px-2 py-0.5 bg-yellow-100 dark:bg-yellow-900/40 text-yellow-700 dark:text-yellow-300 text-xs rounded-full font-medium">Beta</span></div><div class="widget-container flex items-center justify-center bg-gray-50 dark:bg-gray-700/30 rounded-lg p-4 sm:p-6"><elevenlabs-convai agent-id="j9lr1Zv4W5s6khw0lxK5"></elevenlabs-convai><div id="widget-placeholder" class="text-center text-gray-500 dark:text-gray-400 italic hidden p-6">Caricamento assistente vocale...</div></div></div>
              <div class="card-styled bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 p-4 sm:p-6 animate-fade-in" style="animation-delay: 0.1s"><h3 class="text-base sm:text-lg font-semibold text-gray-800 dark:text-white mb-4 flex items-center gap-2"><i class="fas fa-info-circle text-cri-red"></i>Come utilizzarlo</h3><div class="space-y-3"><div class="flex gap-3 items-center"><div class="w-8 h-8 rounded-full bg-red-50 dark:bg-red-900/30 flex items-center justify-center flex-shrink-0"><i class="fas fa-microphone text-cri-red"></i></div><div><p class="text-gray-600 dark:text-gray-300 text-sm">Premi il microfono e poni le tue domande.</p></div></div><div class="flex gap-3 items-center"><div class="w-8 h-8 rounded-full bg-red-50 dark:bg-red-900/30 flex items-center justify-center flex-shrink-0"><i class="fas fa-volume-up text-cri-red"></i></div><div><p class="text-gray-600 dark:text-gray-300 text-sm">L'assistente risponderà a voce.</p></div></div><div class="flex gap-3 items-center"><div class="w-8 h-8 rounded-full bg-red-50 dark:bg-red-900/30 flex items-center justify-center flex-shrink-0"><i class="fas fa-cog text-cri-red"></i></div><div><p class="text-gray-600 dark:text-gray-300 text-sm">Usa le impostazioni del widget per personalizzare.</p></div></div></div></div>
            </div>
          </div>
          <!-- TAB ANALYSIS REMOVED -->
        </div>
      </main>
    </div>
  </div>

  <button id="scroll-bottom-btn" aria-label="Vai in fondo alla chat" class="fixed bottom-20 sm:bottom-24 right-4 sm:right-6 bg-cri-red text-white w-9 h-9 rounded-full flex items-center justify-center shadow-lg opacity-0 pointer-events-none z-40 transition-opacity duration-300 hover:bg-cri-darkred focus-visible:opacity-100 focus-visible:pointer-events-auto"><i class="fas fa-chevron-down"></i></button>

  <!-- MODALS -->
  <div id="guide-modal" class="modal-container"><div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-xl overflow-hidden max-w-2xl"><div class="p-4 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between"><h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center gap-2"><i class="fas fa-question-circle text-cri-red"></i>Guida</h3><button aria-label="Chiudi modale" class="close-modal-btn w-8 h-8 rounded-full flex items-center justify-center text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/50"><i class="fas fa-times"></i></button></div><div class="p-4 sm:p-6 max-h-[70vh] overflow-y-auto custom-scrollbar"><div class="space-y-4"><div><h4 class="text-base font-medium text-gray-900 dark:text-white mb-2 font-display">Benvenuto!</h4><p class="text-gray-600 dark:text-gray-300 text-sm">Questo assistente ti aiuta a trovare informazioni sulla Croce Rossa Italiana.</p></div><div class="grid grid-cols-1 md:grid-cols-2 gap-3"><div class="bg-gray-50 dark:bg-gray-700/30 rounded-lg p-3 border border-gray-100 dark:border-gray-700/50"><h5 class="font-medium text-gray-800 dark:text-white text-sm mb-1 flex items-center gap-1.5"><i class="fas fa-comments text-cri-red/80"></i>Fare domande</h5><p class="text-gray-600 dark:text-gray-300 text-xs">Scrivi nella casella in basso e premi Invio.</p></div><div class="bg-gray-50 dark:bg-gray-700/30 rounded-lg p-3 border border-gray-100 dark:border-gray-700/50"><h5 class="font-medium text-gray-800 dark:text-white text-sm mb-1 flex items-center gap-1.5"><i class="fas fa-plus-circle text-cri-red/80"></i>Conversazioni</h5><p class="text-gray-600 dark:text-gray-300 text-xs">Usa "+" per nuove chat. Clicca su una chat per riprenderla. Usa <i class="fas fa-trash-alt text-xs"></i> per eliminarla.</p></div><div class="bg-gray-50 dark:bg-gray-700/30 rounded-lg p-3 border border-gray-100 dark:border-gray-700/50"><h5 class="font-medium text-gray-800 dark:text-white text-sm mb-1 flex items-center gap-1.5"><i class="fas fa-microphone text-cri-red/80"></i>Vocale (Beta)</h5><p class="text-gray-600 dark:text-gray-300 text-xs">Vai alla scheda "Vocale" per parlare con l'assistente.</p></div><!-- Analysis guide item removed --></div><div class="bg-red-50 dark:bg-red-900/20 p-3 rounded-lg border border-red-100 dark:border-red-900/30 mt-4"><h5 class="font-medium text-gray-800 dark:text-white text-sm mb-1">Disclaimer</h5><p class="text-gray-600 dark:text-gray-300 text-xs">Le risposte sono basate su documenti CRI. Per info ufficiali e complete, visita <a href="https://cri.it" target="_blank" rel="noopener noreferrer" class="text-cri-red hover:underline font-medium">cri.it</a>.</p></div></div></div><div class="p-3 border-t border-gray-100 dark:border-gray-700/50 flex justify-end"><button class="close-modal-btn px-4 py-1.5 bg-cri-red text-white rounded-md hover:bg-cri-darkred transition-colors text-sm font-medium shadow-sm">Ho capito</button></div></div></div>
  <div id="privacy-modal" class="modal-container"><div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-xl overflow-hidden max-w-xl"><div class="p-4 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between"><h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center gap-2"><i class="fas fa-shield-alt text-cri-red"></i>Informativa Privacy</h3><button aria-label="Chiudi modale" class="close-modal-btn w-8 h-8 rounded-full flex items-center justify-center text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/50"><i class="fas fa-times"></i></button></div><div class="p-4 sm:p-6 max-h-[70vh] overflow-y-auto custom-scrollbar"><div class="space-y-3 text-sm"><p class="text-gray-600 dark:text-gray-300">La Croce Rossa Italiana tutela la tua privacy.</p><h4 class="font-medium text-gray-800 dark:text-white mt-3 text-base">Dati Raccolti e Utilizzo</h4><p class="text-gray-600 dark:text-gray-300 text-xs">Le domande e risposte vengono processate per fornire il servizio. Le interazioni possono essere usate in forma anonima per migliorare l'assistente.</p><h4 class="font-medium text-gray-800 dark:text-white mt-3 text-base">Conservazione Dati (Locale)</h4><p class="text-gray-600 dark:text-gray-300 text-xs">Le tue chat sono salvate <strong class="font-medium">solo sul tuo dispositivo</strong> (localStorage). Puoi eliminarle con <i class="fas fa-trash-alt text-xs"></i>. Nessun dato della chat viene salvato sui server CRI, tranne query anonime per il miglioramento AI.</p><div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-100 dark:border-blue-900/30 mt-4"><p class="text-gray-700 dark:text-gray-200 text-xs">Per la policy completa: <a href="https://cri.it/privacy" target="_blank" rel="noopener noreferrer" class="text-cri-red hover:underline font-medium">Privacy Policy CRI</a>.</p></div></div></div><div class="p-3 border-t border-gray-100 dark:border-gray-700/50 flex justify-end"><button class="close-modal-btn px-4 py-1.5 bg-cri-red text-white rounded-md hover:bg-cri-darkred transition-colors text-sm font-medium shadow-sm">Ho capito</button></div></div></div>
  <div id="delete-chat-modal" class="modal-container"><div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-xl overflow-hidden max-w-md"><div class="p-4 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between"><h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center gap-2"><i class="fas fa-trash-alt text-cri-red"></i>Elimina chat</h3><button aria-label="Chiudi modale" class="close-modal-btn w-8 h-8 rounded-full flex items-center justify-center text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/50"><i class="fas fa-times"></i></button></div><div class="p-6"><p class="text-gray-600 dark:text-gray-300 text-sm">Sei sicuro? La chat verrà eliminata solo dal tuo dispositivo. L'azione è irreversibile.</p></div><div class="p-3 border-t border-gray-100 dark:border-gray-700/50 flex justify-end space-x-3"><button class="close-modal-btn px-4 py-1.5 border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-sm font-medium">Annulla</button><button id="confirm-delete-btn" class="px-4 py-1.5 bg-cri-red text-white rounded-md hover:bg-cri-darkred transition-colors text-sm font-medium shadow-sm">Elimina</button></div></div></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
  <script src="https://elevenlabs.io/convai-widget/index.js" async defer type="text/javascript"></script>

  <script>
    // --- Constants ---
    const API_BASE_URL = '/api';
    const INITIAL_ASSISTANT_WELCOME = "Sono qui per rispondere alle tue domande sulla Croce Rossa Italiana, fornire informazioni sui servizi e guidarti nelle attività di volontariato. Come posso aiutarti oggi?";
    const ASSISTANT_TYPING_PLACEHOLDER = "Assistente sta scrivendo...";

    // --- DOM Elements ---
    const messageInput = document.getElementById('message-input');
    const chatForm = document.getElementById('chat-form');
    const sendMessageBtn = document.getElementById('send-message-btn');
    const chatMessages = document.getElementById('chat-messages');
    const scrollBottomBtn = document.getElementById('scroll-bottom-btn');
    const newChatBtn = document.getElementById('new-chat-btn');
    const mobileNewChatBtn = document.getElementById('mobile-new-chat-btn');
    const chatsList = document.getElementById('chats-list');
    const mobileChatsList = document.getElementById('mobile-chats-list');
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const closeMobileMenu = document.getElementById('close-mobile-menu');
    const mobileSidebar = document.getElementById('mobile-sidebar');
    const mobileBackdrop = document.getElementById('mobile-backdrop');
    const mobileSidebarContent = mobileSidebar ? mobileSidebar.querySelector('.mobile-sidebar-content') : null;
    const themeToggle = document.getElementById('theme-toggle');
    const htmlElement = document.documentElement;
    const deleteChatModal = document.getElementById('delete-chat-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const guideModal = document.getElementById('guide-modal');
    const privacyModal = document.getElementById('privacy-modal');
    const guideBtn = document.getElementById('guide-btn');
    const mobileGuideBtn = document.getElementById('mobile-guide-btn');
    const privacyBtn = document.getElementById('privacy-btn');
    const mobilePrivacyBtn = document.getElementById('mobile-privacy-btn');
    const tabSwitcherBtns = document.querySelectorAll('.tab-switcher');
    const mobileTabs = document.querySelectorAll('.mobile-tab-btn');
    const tabChat = document.getElementById('tab-chat');
    const tabVoice = document.getElementById('tab-voice');
    const notificationBanner = document.getElementById('notification-banner');
    const notificationText = document.getElementById('notification-text');
    const closeNotification = document.getElementById('close-notification');
    const suggestionChips = document.querySelectorAll('.suggestion-chip');

    // --- State Variables ---
    let activeSessionId = null;
    let currentChatId = null;
    let chatToDelete = null;
    let isLoading = false;
    let chats = [];
    let darkMode = localStorage.getItem('cri_theme') === 'dark';
    let scrollTimeout = null;

    // --- MODIFICA: Variabili per l'indicatore di attesa ---
    let waitingTextInterval = null;
    const waitingPhrases = [
        "Sto cercando la risposta migliore per te...",
        "Consulto i documenti della Croce Rossa...",
        "Un momento di pazienza, grazie...",
        "Elaboro la tua richiesta...",
        "Sto preparando le informazioni..."
    ];

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', function() {
        AOS.init({ once: true, duration: 400, offset: 30, disable: 'mobile', easing: 'ease-out-cubic' });
        initApp();
        setupEventListeners();
        observeElevenLabsWidget();
    });

    function initApp() {
        loadTheme();
        loadSavedChats();
        if (chats.length === 0) {
            createNewChat();
        } else {
            chats.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));
            const lastActive = chats.find(c => c.isActive) || chats[0];
            activateChat(lastActive.id);
        }
        adjustTextareaHeight();
        switchTab('chat');
        setTimeout(() => { messageInput.focus(); }, 300);
    }

    // --- Event Listeners ---
    function setupEventListeners() {
        messageInput.addEventListener('input', handleInput);
        messageInput.addEventListener('keydown', handleKeydown);
        chatForm.addEventListener('submit', handleSubmit);
        scrollBottomBtn.addEventListener('click', () => scrollToBottom(true));
        chatMessages.addEventListener('scroll', handleScroll);
        tabSwitcherBtns.forEach(btn => btn.addEventListener('click', () => switchTab(btn.id.split('-')[1])));
        mobileTabs.forEach(tab => tab.addEventListener('click', () => { switchTab(tab.dataset.tab); closeMobileSidebar(); }));
        themeToggle.addEventListener('click', toggleTheme);
        mobileMenuBtn.addEventListener('click', openMobileSidebar);
        closeMobileMenu.addEventListener('click', closeMobileSidebar);
        mobileBackdrop.addEventListener('click', closeMobileSidebar);
        newChatBtn.addEventListener('click', createNewChat);
        mobileNewChatBtn.addEventListener('click', () => { createNewChat(); closeMobileSidebar(); });
        guideBtn.addEventListener('click', () => showModal(guideModal));
        if (mobileGuideBtn) mobileGuideBtn.addEventListener('click', () => { showModal(guideModal); closeMobileSidebar(); });
        privacyBtn.addEventListener('click', () => showModal(privacyModal));
        if (mobilePrivacyBtn) mobilePrivacyBtn.addEventListener('click', () => { showModal(privacyModal); closeMobileSidebar(); });
        document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', closeAllModals));
        document.querySelectorAll('.modal-container').forEach(modal => modal.addEventListener('click', (e) => { if (e.target === modal) closeAllModals(); }));
        confirmDeleteBtn.addEventListener('click', handleDeleteConfirm);
        suggestionChips.forEach(chip => chip.addEventListener('click', handleSuggestionClick));
        closeNotification.addEventListener('click', hideNotification);
        window.addEventListener('resize', handleScroll);
    }

    // --- Event Handlers (Brief) ---
    function handleInput() { adjustTextareaHeight(); sendMessageBtn.disabled = messageInput.value.trim() === ''; }
    function handleKeydown(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); if (messageInput.value.trim() && !isLoading) chatForm.requestSubmit(); } }
    function handleSubmit(e) { e.preventDefault(); const msg = messageInput.value.trim(); if (!msg || isLoading) return; addMessage(msg, true); messageInput.value = ''; adjustTextareaHeight(); sendMessageBtn.disabled = true; messageInput.focus(); isLoading = true; showTypingIndicator(); sendQuestion(msg); }
    function handleScroll() { clearTimeout(scrollTimeout); scrollTimeout = setTimeout(toggleScrollButton, 150); }
    function toggleTheme() { darkMode = !darkMode; setTheme(darkMode ? 'dark' : 'light'); }
    function handleDeleteConfirm() { if (chatToDelete) { deleteChat(chatToDelete); closeAllModals(); } }
    function handleSuggestionClick() { if (isLoading) return; const q = this.textContent.trim(); messageInput.value = q; adjustTextareaHeight(); sendMessageBtn.disabled = false; messageInput.focus(); setTimeout(() => chatForm.requestSubmit(), 50); }

    // --- Core Chat & State Logic ---
    function loadTheme() { const saved = localStorage.getItem('cri_theme') || 'light'; darkMode = (saved === 'dark'); setTheme(saved); }
    function setTheme(theme) { htmlElement.classList.toggle('dark', theme === 'dark'); localStorage.setItem('cri_theme', theme); const icon = themeToggle.querySelector('i'); icon.classList.toggle('fa-moon', theme === 'light'); icon.classList.toggle('fa-sun', theme === 'dark'); }
    function loadSavedChats() { const s = localStorage.getItem('cri_chats'); chats = []; if (s) { try { const p = JSON.parse(s); if (Array.isArray(p)) chats = p; else localStorage.removeItem('cri_chats'); } catch (e) { console.error(e); localStorage.removeItem('cri_chats');}} chats=chats.map(c=>({id:c.id||`c_${Date.now()}`,sessionId:c.sessionId||`s_${Date.now()}`,title:c.title||'Chat',lastUpdated:c.lastUpdated||new Date().toISOString(),isActive:c.isActive||!1,messages:Array.isArray(c.messages)?c.messages:[],createdAt:c.createdAt||c.lastUpdated||new Date().toISOString()})); renderChatsList(); }
    function saveChats() { try { chats.sort((a,b)=>new Date(b.lastUpdated)-new Date(a.lastUpdated));localStorage.setItem('cri_chats',JSON.stringify(chats))}catch(e){console.error(e);if(e instanceof DOMException&&(e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED')&&chats.length>10){chats=chats.slice(0,10);localStorage.setItem('cri_chats',JSON.stringify(chats));showNotification("Spazio esaurito, chat vecchie rimosse.","warning")}else showNotification("Errore salvataggio: Spazio esaurito.","error")}}
    function createNewChat() { const n=new Date().toISOString(),c='chat_'+Date.now(),s='session_'+Date.now()+'_'+Math.random().toString(36).substring(2,8);chats.forEach(h=>h.isActive=!1);const newC={id:c,sessionId:s,title:'Nuova conversazione',lastUpdated:n,isActive:!0,messages:[],createdAt:n};chats.unshift(newC);saveChats();renderChatsList();activateChat(c);switchTab('chat');return c;}
    function activateChat(id) { const i=chats.findIndex(c=>c.id===id);if(i===-1){if(chats.length>0)activateChat(chats[0].id);else createNewChat();return}chats.forEach((c,idx)=>c.isActive=idx===i);currentChatId=id;activeSessionId=chats[i].sessionId;renderChatsList();loadChatMessages(id);closeMobileSidebar();saveChats();switchTab('chat');setTimeout(()=>messageInput.focus(),100)}
    function deleteChat(id) { const i=chats.findIndex(c=>c.id===id);if(i===-1)return;const act=chats[i].isActive;chats.splice(i,1);if(act){if(chats.length>0){chats.sort((a,b)=>new Date(b.lastUpdated)-new Date(a.lastUpdated));activateChat(chats[0].id)}else createNewChat()}else renderChatsList();saveChats()}
    function renderChatsList() { chatsList.innerHTML='';mobileChatsList.innerHTML='';chats.sort((a,b)=>new Date(b.lastUpdated)-new Date(a.lastUpdated));if(chats.length===0){const p='<p class="text-center text-xs text-gray-400 dark:text-gray-500 p-4">Nessuna chat.</p>';chatsList.innerHTML=p;mobileChatsList.innerHTML=p;return}chats.forEach(c=>{const d=createChatListItem(c),m=createChatListItem(c);chatsList.appendChild(d);mobileChatsList.appendChild(m)})}
    function createChatListItem(c) {
        const i=document.createElement('div');
        i.className=`flex items-center justify-between p-2 rounded-lg cursor-pointer transition-colors mb-1 group ${c.isActive?'bg-red-100 dark:bg-red-900/40':'hover:bg-gray-100 dark:hover:bg-gray-700/50'}`;
        i.dataset.chatId=c.id;
        const d=new Date(c.lastUpdated),n=new Date(),f=d.toDateString()===n.toDateString()?d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):d.toLocaleDateString([],{month:'short',day:'numeric'});
        i.innerHTML=`
            <div class="flex items-center flex-1 overflow-hidden gap-2">
                <div class="w-8 h-8 rounded-lg ${c.isActive?'bg-cri-red text-white':'bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400'} flex items-center justify-center flex-shrink-0 transition-colors">
                    <i class="fas fa-comment-dots text-sm"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="truncate text-sm font-medium ${c.isActive?'text-cri-red dark:text-red-300':'text-gray-700 dark:text-gray-200'}">${c.title}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">${f}</div>
                </div>
            </div>
            <button aria-label="Elimina ${c.title}" class="delete-chat-btn ml-1 p-1.5 rounded-full text-gray-400 hover:text-cri-red hover:bg-red-100 dark:hover:bg-red-900/30 transition-all focus:opacity-100 flex-shrink-0">
                <i class="fas fa-trash-alt text-xs"></i>
            </button>
        `;
        i.addEventListener('click',e=>{if(!e.target.closest('.delete-chat-btn'))activateChat(c.id)});
        const b=i.querySelector('.delete-chat-btn');
        b.addEventListener('click',e=>{e.stopPropagation();chatToDelete=c.id;showModal(deleteChatModal)});
        return i
    }
    function resetChatInterface() { chatMessages.innerHTML = ''; }
    function loadChatMessages(id) {
        resetChatInterface();
        const chat = chats.find(c => c.id === id);
        if (!chat) return;
        let welcomeAdded = false;
        if (!chat.messages || chat.messages.length === 0 || chat.messages[0].isUser) {
             addWelcomeMessageToUI(chat.createdAt || chat.lastUpdated);
             welcomeAdded = true;
        }
        if (chat.messages && chat.messages.length > 0) {
            chat.messages.forEach(msg => {
                 const isFirstSavedWelcome = chat.messages.indexOf(msg) === 0 && !msg.isUser && msg.text.includes("Benvenuto all'Assistente CRI");
                 if (!isFirstSavedWelcome) {
                    addMessageToUI(msg.text, msg.isUser, msg.timestamp, msg.sources);
                 } else if (!welcomeAdded) {
                      addWelcomeMessageToUI(msg.timestamp, msg.text);
                 }
            });
        }
        scrollToBottom();
    }
    function addWelcomeMessageToUI(ts = null, customText = null) {
        if (chatMessages.querySelector('.fa-robot')) return;
        const d = document.createElement('div');
        d.className = 'flex flex-col md:flex-row items-start gap-3 md:gap-4 p-3 md:p-4 bg-white dark:bg-gray-800 rounded-xl shadow-md border border-gray-100 dark:border-gray-700 animate-slide-in-left message-bubble';
        const welcomeText = customText || "Benvenuto all'Assistente CRI\nSono qui per rispondere alle tue domande sulla Croce Rossa Italiana. Come posso aiutarti oggi?";
        const timeString = ts ? new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
        d.innerHTML = `
            <div class="w-10 h-10 md:w-11 md:h-11 flex-shrink-0 bg-red-50 dark:bg-red-900/30 rounded-xl flex items-center justify-center"><i class="fas fa-robot text-cri-red text-xl md:text-2xl"></i></div>
            <div class="flex-grow">
                <h2 class="text-base sm:text-lg font-semibold text-gray-800 dark:text-white mb-1 font-display">Assistente CRI</h2>
                <p class="text-sm text-gray-600 dark:text-gray-300 whitespace-pre-wrap">${welcomeText}</p>
                <div class="text-[10px] text-gray-400 dark:text-gray-500 mt-2 text-left">${timeString}</div>
            </div>`;
        if (chatMessages.firstChild) {
            chatMessages.insertBefore(d, chatMessages.firstChild);
        } else {
            chatMessages.appendChild(d);
        }
    }
    function adjustTextareaHeight() { const maxH=120;messageInput.style.height='auto';const sH=messageInput.scrollHeight;messageInput.style.height=Math.min(sH,maxH)+'px';messageInput.style.overflowY=sH>maxH?'auto':'hidden';}
    function addMessage(txt,isU,src=null){const ts=new Date().toISOString();addMessageToUI(txt,isU,ts,src);saveMessageToChat(txt,isU,src,ts)}
    function addMessageToUI(txt,isU,ts=null,src=null){const d=document.createElement('div');d.className=`message-bubble animate-${isU?'slide-in-right':'slide-in-left'} clear-both flex ${isU?'justify-end':'justify-start'} mb-3`;const tS=ts?new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});let mC='';if(isU){mC=`<div class="bg-cri-red text-white rounded-xl rounded-tr-none py-2 px-3 max-w-[85%] shadow-md"><div class="whitespace-pre-wrap text-sm">${txt}</div><div class="text-[10px] text-white text-opacity-70 text-right mt-1">${tS}</div></div>`}else{const hC=marked.parse(txt);let sH='';if(src&&src.length>0){const uS=new Set(src.map(s=>s?.metadata?.filename).filter(Boolean));if(uS.size>0){sH=`<div class="mt-2 pt-1.5 border-t border-gray-200 dark:border-gray-600/50"><div class="flex items-center justify-between cursor-pointer sources-toggle group"><span class="text-xs font-medium text-gray-500 dark:text-gray-400 group-hover:text-cri-red">Fonti (${uS.size})</span><button aria-label="Mostra fonti" class="text-xs text-gray-400 group-hover:text-cri-red p-0.5"><i class="fas fa-chevron-down toggle-icon transition-transform duration-200 text-[10px]"></i></button></div><div class="sources-content hidden mt-1 text-xs text-gray-500 dark:text-gray-400"><ul class="space-y-0.5 pl-1">${Array.from(uS).map(s=>`<li class="flex items-start gap-1.5"><i class="fas fa-file-alt text-cri-red/60 flex-shrink-0 mt-0.5"></i><span class="break-all text-[11px]">${s.replace('.md','').replace(/_/g,' ')}</span></li>`).join('')}</ul></div></div>`}}mC=`<div class="bg-white dark:bg-gray-800 rounded-xl rounded-tl-none py-2 px-3 max-w-[85%] shadow-md border border-gray-100 dark:border-gray-700"><div class="prose prose-sm prose-chat dark:prose-invert max-w-none text-gray-800 dark:text-gray-100">${hC}</div>${sH}<div class="text-[10px] text-gray-400 dark:text-gray-500 text-left mt-1">${tS}</div></div>`}d.innerHTML=mC;chatMessages.appendChild(d);const sT=d.querySelector('.sources-toggle');if(sT){sT.addEventListener('click',function(){const c=this.nextElementSibling,i=this.querySelector('.toggle-icon'),h=c.classList.toggle('hidden');i.classList.toggle('rotate-180',!h);setTimeout(()=>{const mB=d.offsetTop+d.offsetHeight;if(mB>chatMessages.scrollTop+chatMessages.clientHeight)chatMessages.scrollTo({top:chatMessages.scrollTop+50,behavior:'smooth'})},150)})}if(chatMessages.scrollHeight>chatMessages.clientHeight)scrollToBottom()}
    function saveMessageToChat(txt,isU,src=null,ts=null){if(!currentChatId)return;const i=chats.findIndex(c=>c.id===currentChatId);if(i===-1)return;if(!chats[i].messages)chats[i].messages=[];const timestampToSave=ts||new Date().toISOString();chats[i].messages.push({text:txt,isUser:isU,sources:src,timestamp:timestampToSave});if(isU&&chats[i].title==='Nuova conversazione'&&chats[i].messages.filter(m=>m.isUser).length===1){const w=txt.split(' ');chats[i].title=w.slice(0,4).join(' ')+(w.length>4?'...':'');renderChatsList()}chats[i].lastUpdated=timestampToSave;saveChats()}
    
    // --- MODIFICA: Funzione per mostrare l'indicatore di attesa animato ---
    function showTypingIndicator() {
        if (document.getElementById('typing-indicator')) return;

        const d = document.createElement('div');
        d.id = 'typing-indicator';
        d.className = 'message-bubble animate-fade-in flex justify-start mb-3 clear-both';
        d.innerHTML = `
            <div class="bg-white dark:bg-gray-800 rounded-xl rounded-tl-none py-3 px-4 shadow-md border border-gray-100 dark:border-gray-700 flex items-center gap-3">
                <div class="spinner !w-5 !h-5 !border-2"></div>
                <span id="waiting-text" class="text-sm text-gray-600 dark:text-gray-300 italic transition-opacity duration-200"></span>
            </div>`;
        chatMessages.appendChild(d);

        const waitingTextElement = document.getElementById('waiting-text');
        if (waitingTextElement) {
            let phraseIndex = 0;
            // Mostra la prima frase immediatamente
            waitingTextElement.textContent = waitingPhrases[phraseIndex];

            // Avvia l'intervallo per ruotare le frasi ogni 4 secondi
            waitingTextInterval = setInterval(() => {
                phraseIndex = (phraseIndex + 1) % waitingPhrases.length;
                
                // Dissolvenza per un cambio più morbido
                waitingTextElement.style.opacity = '0';
                setTimeout(() => {
                    waitingTextElement.textContent = waitingPhrases[phraseIndex];
                    waitingTextElement.style.opacity = '1';
                }, 250); // Deve corrispondere alla durata della transizione

            }, 8000);
        }
        scrollToBottom();
    }

    // --- MODIFICA: Funzione per rimuovere l'indicatore e fermare la rotazione ---
    function removeTypingIndicator() {
        // Interrompi l'intervallo per la rotazione del testo
        if (waitingTextInterval) {
            clearInterval(waitingTextInterval);
            waitingTextInterval = null;
        }
        // Rimuovi l'elemento dalla UI
        const indicator = document.getElementById('typing-indicator');
        if (indicator) {
            indicator.remove();
        }
    }

    // --- SEND QUESTION - Updated Version v2 ---
    async function sendQuestion(question) {
        try {
            if (!activeSessionId) {
                console.error("Nessun activeSessionId per sendQuestion");
                addMessage("Errore di sessione. Prova a iniziare una nuova chat.", false);
                isLoading = false; removeTypingIndicator(); return;
            }

            const currentChatObject = chats.find(c => c.id === currentChatId);
            const baseConversationHistory = currentChatObject?.messages
                ?.filter(msg => !(msg.isUser && msg.text === question))
                .map(msg => ({
                    type: msg.isUser ? "user" : "assistant",
                    content: msg.text
                })) || [];

            let historyToSendToAPI = [];

            if (baseConversationHistory.length === 0) {
                console.log(">>> PRIMA DOMANDA: Costruendo storia API artificiale <<<");
                historyToSendToAPI = [
                    { type: "assistant", content: INITIAL_ASSISTANT_WELCOME },
                    { type: "user", content: question },
                    { type: "assistant", content: ASSISTANT_TYPING_PLACEHOLDER }
                ];
            } else {
                console.log(">>> DOMANDA SUCCESSIVA: Usando storia reale + domanda corrente <<<");
                historyToSendToAPI = [...baseConversationHistory];
                historyToSendToAPI.push({ type: "user", content: question });
            }

            const requestData = {
                query: question,
                session_id: activeSessionId,
                conversation_history: historyToSendToAPI,
                include_prompt: true
            };

            console.log("Contesto INVIATO AL BACKEND:", JSON.stringify(requestData));

            const response = await fetch(`${API_BASE_URL}/query`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });

            const data = await response.json();
            console.log("Risposta DAL BACKEND:", data);

            if (data.source_documents && data.source_documents.length > 0) {
                console.log(`%c📚 ${data.source_documents.length} chunks RAG:`, 'color: #e3000f; font-weight: bold;', data.source_documents.map(d => d?.metadata?.filename || 'N/D'));
            }
            if (data.condensed_question) {
                 console.log(`%c🔍 Query riformulata: "${data.condensed_question}"`, 'color: #0066cc; font-weight: bold;');
            }
            if (data.full_prompt) {
                console.log('%c📝 Prompt LLM (Inizio):', 'color: purple; font-weight: bold;', data.full_prompt.substring(0, 500) + "...");
            }

            await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 400));
            removeTypingIndicator();

            if (response.ok) {
                addMessage(data.answer, false, data.source_documents);
            } else {
                addMessage(`Errore (${response.status}): ${data.detail || data.error || response.statusText}. Riprova.`, false);
                console.error("Errore API:", data);
            }
        } catch (error) {
            console.error("Errore Fetch in sendQuestion:", error);
            removeTypingIndicator();
            const errorMsg = (error instanceof TypeError && error.message.includes('Failed to fetch')) ? "Errore di connessione. Verifica la rete." : "Errore imprevisto. Riprova più tardi.";
            addMessage(errorMsg, false);
        } finally {
            isLoading = false;
            sendMessageBtn.disabled = messageInput.value.trim() === '';
        }
    }
    // --- END OF SEND QUESTION ---


    // --- UI Helpers ---
    function scrollToBottom(smooth=false){const isScrolledUp=chatMessages.scrollHeight - chatMessages.scrollTop - chatMessages.clientHeight > 100; if(!isScrolledUp||smooth)chatMessages.scrollTo({top:chatMessages.scrollHeight,behavior:smooth?'smooth':'auto'}); toggleScrollButton();}
    function toggleScrollButton(){const showThreshold=150,isScrolledUp=chatMessages.scrollHeight - chatMessages.scrollTop - chatMessages.clientHeight > showThreshold;scrollBottomBtn.classList.toggle('opacity-0',!isScrolledUp);scrollBottomBtn.classList.toggle('pointer-events-none',!isScrolledUp)}
    function switchTab(tabName){tabSwitcherBtns.forEach(b=>{const btnTabName=b.id.split('-')[1];b.classList.toggle('bg-white',btnTabName===tabName);b.classList.toggle('bg-opacity-20',btnTabName===tabName);b.classList.toggle('hover:bg-white/20',btnTabName!==tabName)});mobileTabs.forEach(b=>{const isActive=b.dataset.tab===tabName;b.classList.toggle('bg-red-50',isActive);b.classList.toggle('dark:bg-red-900/30',isActive);b.classList.toggle('text-cri-red',isActive);b.classList.toggle('text-gray-600',!isActive);b.classList.toggle('dark:text-gray-400',!isActive);b.classList.toggle('hover:bg-gray-100',!isActive);b.classList.toggle('dark:hover:bg-gray-700/50',!isActive);});[tabChat,tabVoice].forEach(t=>t?.classList.add('hidden'));const activeTab=document.getElementById(`tab-${tabName}`);if(activeTab){activeTab.classList.remove('hidden');if(tabName==='voice')AOS.refreshHard();ensureWidgetPlacement()} }
    function openMobileSidebar(){if(!mobileSidebar||!mobileBackdrop||!mobileSidebarContent)return;mobileSidebar.classList.remove('hidden');document.body.style.overflow='hidden';requestAnimationFrame(()=>{mobileBackdrop.classList.remove('opacity-0');mobileSidebarContent.classList.remove('-translate-x-full')})}
    function closeMobileSidebar(){if(!mobileSidebar||!mobileBackdrop||!mobileSidebarContent)return;mobileBackdrop.classList.add('opacity-0');mobileSidebarContent.classList.add('-translate-x-full');setTimeout(()=>{mobileSidebar.classList.add('hidden');document.body.style.overflow=''},300)}
    function showModal(m){if(!m)return;m.classList.add('active');const f=m.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),c=m.querySelector('.close-modal-btn');if(f)f.focus();else if(c)c.focus()}
    function closeAllModals(){document.querySelectorAll('.modal-container.active').forEach(m=>m.classList.remove('active'));chatToDelete=null}
    function showNotification(txt,type='info'){notificationText.textContent=txt;notificationBanner.className=notificationBanner.className.replace(/bg-(cri-red|green-500|yellow-500)/g,'');let bgC='bg-cri-red';if(type==='success')bgC='bg-green-500';else if(type==='warning')bgC='bg-yellow-500';notificationBanner.classList.add(bgC);notificationBanner.classList.remove('-translate-y-full');setTimeout(hideNotification,4000)}
    function hideNotification(){notificationBanner.classList.add('-translate-y-full')}
    function ensureWidgetPlacement(){setTimeout(()=>{const w=document.querySelector('elevenlabs-convai'),c=document.querySelector('#tab-voice .widget-container'),p=document.getElementById('widget-placeholder');if(w&&c&&w.parentNode!==c){console.log("Moving ElevenLabs widget...");c.innerHTML='';c.appendChild(w);if(p)p.classList.add('hidden')}else if(!w&&c&&p)p.classList.remove('hidden')},300)}
    function observeElevenLabsWidget(){const o=new MutationObserver(m=>{for(const mut of m)if(mut.type==='childList')mut.addedNodes.forEach(n=>{if(n.tagName==='ELEVENLABS-CONVAI'){console.log("ElevenLabs widget added to DOM, ensuring placement.");ensureWidgetPlacement()}})});o.observe(document.body,{childList:!0,subtree:!0});ensureWidgetPlacement()}
  </script>
</body>
</html>